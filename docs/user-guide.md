# 用户使用指南

本指南详细介绍了 Telegraf 配置管理系统的各项功能和操作流程，旨在帮助用户充分利用本系统。

## 1. 仪表盘

仪表盘是您登录后看到的第一个界面，它提供了系统的核心指标和状态的快速概览。

- **关键指标卡片**: 显示了当前系统管理的 **运行中进程**、**配置文件总数**、**数据点总数** 和 **数据源数量**。
- **系统状态**: 展示了应用本身、数据库及关键依赖（如 Telegraf）的健康状态和版本信息。
- **最近活动**: 显示了最近在系统内发生的重要操作审计日志，方便追溯。
- **运行中进程概览**: 列出了当前运行中的部分进程及其关键性能指标（PID、状态、运行时长、CPU、内存）。

## 2. 配置文件管理

这是系统的核心功能之一，您可以在此创建、编辑和管理所有 Telegraf 配置文件。

### 2.1. 查看配置文件列表

- **文件名**: 配置文件的名称。
- **版本**: 每个文件都有版本号，每次修改都会创建一个新版本。
- **数据点同步**: 显示该配置文件中的数据点是否已与系统中的数据点信息同步。
- **运行状态**: 显示是否有基于此配置文件的 Telegraf 进程正在运行。如果未运行，会提供一个快捷的“启动”按钮。

### 2.2. 创建和编辑配置文件

- **创建**: 点击“新建配置文件”按钮，您可以从一个空白的编辑器开始编写配置。
- **编辑**: 点击任意文件行的“查看/编辑”按钮，进入文件编辑视图。
- **分段式编辑器**: 为了便于管理大型配置文件，编辑器会自动将配置按 `[agent]`, `[[inputs.xxx]]`, `[[outputs.xxx]]` 等顶级或次级插件配置分割成可折叠的片段。
- **保存与验证**: 保存配置时，系统会自动在后台运行 `telegraf --test` 来验证配置的有效性。如果验证失败，会在页面顶部弹出明确的错误提示，帮助您定位问题。

### 2.3. 版本控制

- **历史版本**: 在编辑视图的“历史版本”标签页中，列出了该文件的所有历史版本。
- **激活版本**: 您可以将任意一个历史版本设置为“激活”状态，系统将使用这个版本的配置内容进行操作。
- **差异对比**: （开发中）未来将支持对比不同版本之间的内容差异。

### 2.4. 数据预览 (快照)

- 在配置文件列表页，点击“数据预览”按钮（<i class="bi bi-camera"></i>），系统会执行一次 `telegraf --once` 命令。
- 这会使用该配置文件（临时添加一个文件输出插件）运行一次 Telegraf，捕获其输出的数据点，并以表格形式展示给您。
- **这是验证输入插件（如 OPC-UA）是否能成功连接并拉取到数据的最直接方式。** 如果预览为空，通常意味着输入插件配置有误或无法连接到数据源。

### 2.5. 锁定/解锁

- 点击“锁定”按钮可以防止一个配置文件被编辑或删除，这对于正在生产环境中使用的重要配置非常有用。
- 当一个配置文件被锁定时，其关联的进程也无法被停止或修改，进一步保证了系统的稳定性。

## 3. 数据点管理

数据点是 Telegraf 采集的最小监控单元。本系统提供了强大的数据点管理功能。

### 3.1. 从配置中提取数据点 (向导)

这是本系统最具特色的功能之一。当您有一个复杂的配置文件（尤其是包含大量节点的 OPC-UA 配置）时，手动录入每个数据点非常繁琐且容易出错。

1.  在配置文件列表页，点击“解析并导入数据点”按钮（<i class="bi bi-magic"></i>）。
2.  系统会启动一个向导，首先通过解析 TOML 结构，让您选择包含主要数据点信息的列表（通常是 `[[inputs.opcua.group]]` 或 `[[inputs.opcua.node]]`）。
3.  在第二步中，您可以将 TOML 文件中的字段（如 `name`, `identifier`）映射到系统数据点的标准字段（如 `measurement`, `original_point_name`）上。
4.  第三步是预览。系统会展示即将生成的数据点，并自动检查这些点位在数据库中的状态：
    - **新点位**: 数据库中不存在的全新点位。
    - **可合并**: 数据库中已存在同名点位，但尚未与任何配置文件关联。向导会自动选择合并，将该点位与当前配置文件关联。
    - **冲突**: 数据库中已存在同名点位，且已与其他配置文件关联。
    - **内部重复**: 在本次提取的列表中存在重复的点位名称。
5.  向导会引导您解决所有冲突（例如，通过重命名），直到所有点位状态正常，然后便可一键导入。

### 3.2. 数据点的手动管理

您也可以在“数据点管理”页面手动创建、编辑、删除数据点，或进行批量导入导出操作。

### 3.3. 导入与回滚

- 每次通过向导或批量导入功能创建/更新的数据点都会被赋予一个唯一的“批次ID”。
- 在“导入/导出”页面的“导入历史”中，您可以看到所有的导入批次。
- 如果发现某次导入有误，可以点击“回滚”按钮。系统会安全地回滚这次操作：
    - 对于该批次中“创建”的点位，执行删除。
    - 对于该批次中“更新”的点位，从其历史记录中恢复到更新前的状态。

## 4. 进程管理

此页面用于监控和管理所有正在运行的 Telegraf 进程。

- **系统管理进程**: 由本系统通过配置文件启动的进程。您可以对它们进行“停止”、“重启”等操作。
- **非系统管理进程**: 在操作系统中发现的、但不是由本系统启动的 Telegraf 进程（例如，通过 `systemctl` 启动的系统服务）。本系统可以监控它们的状态，并提供“停止”操作，但建议通过其原有的管理方式进行操作。
- **重启前的配置测试**: 当您尝试重启一个“系统管理进程”时，系统会提供一个“测试”按钮，它会先用该进程关联的配置文件进行一次测试，只有测试通过后，“安全重启”按钮才可用，这可以有效防止因配置错误导致监控中断。

## 5. 导入/导出

此模块提供了数据点和配置的批量处理能力。

- **数据点导入/导出**: 支持通过 CSV 或 Excel 文件批量导入和导出数据点信息。
- **导入历史**: 如上文所述，提供所有导入批次的回滚功能。
